name: Deploy Bot

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.github/**'
      - '!.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  PROJECT_PATH: /root/football-news-bot

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸš€ Deploy to Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        command_timeout: 30m
        script: |
          set -e

          echo "================================"
          echo "ğŸš€ Football News Bot Deployment"
          echo "================================"

          # Install Docker if needed
          if ! command -v docker &> /dev/null; then
            echo "ğŸ“¦ Installing Docker..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sh get-docker.sh
            rm get-docker.sh
            apt-get install -y docker-compose-plugin git
            systemctl start docker
            systemctl enable docker
          fi

          # Clone or pull repository
          if [ ! -d "${{ env.PROJECT_PATH }}" ]; then
            echo "ğŸ“‚ Cloning repository..."
            git clone https://github.com/${{ github.repository }}.git ${{ env.PROJECT_PATH }}
          else
            echo "ğŸ“¦ Updating repository..."
            cd ${{ env.PROJECT_PATH }}
            git fetch origin
            git reset --hard origin/main
          fi

          cd ${{ env.PROJECT_PATH }}

          # Create .env file
          echo "âš™ï¸  Creating .env..."
          cat > .env << 'ENVEOF'
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          DATABASE_URL=sqlite+aiosqlite:///./data/news_bot.db
          PARSE_INTERVAL_MINUTES=30
          MAX_NEWS_PER_REQUEST=10
          ENVEOF

          # Create directories
          mkdir -p data logs

          # Deploy with Docker
          echo "ğŸ›‘ Stopping old container..."
          docker compose down 2>/dev/null || true

          echo "ğŸ—ï¸  Building and starting..."
          docker compose up -d --build

          echo "â³ Waiting for startup..."
          sleep 8

          echo ""
          echo "================================"
          echo "ğŸ“Š Status"
          echo "================================"
          docker compose ps

          echo ""
          echo "ğŸ“‹ Recent logs:"
          docker compose logs --tail=25

          echo ""
          if docker compose ps | grep -q "Up"; then
            echo "âœ… Bot is running!"
            exit 0
          else
            echo "âŒ Bot failed to start"
            docker compose logs
            exit 1
          fi

    - name: ğŸ“Š Summary
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Deployment successful!"
          echo ""
          echo "Next: Open Telegram and send /start to your bot"
        else
          echo "âŒ Deployment failed - check logs above"
        fi
