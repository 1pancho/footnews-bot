name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deployment'
        required: false
        default: 'Manual deployment'

env:
  PROJECT_PATH: /root/football-news-bot

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ” Pre-deployment checks
      run: |
        echo "### ðŸš€ Manual Deployment Started" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Reason**: ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: ðŸš€ Deploy to VPS
      id: deploy
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        command_timeout: 30m
        script: |
          set -e

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ðŸš€ Football News Bot Deployment"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Check if Docker is installed
          if ! command -v docker &> /dev/null; then
            echo "ðŸ“¦ Installing Docker..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sh get-docker.sh
            rm get-docker.sh
            apt-get install -y docker-compose-plugin git
            systemctl start docker
            systemctl enable docker
          else
            echo "âœ… Docker is already installed"
          fi

          # Check if project directory exists
          if [ ! -d "${{ env.PROJECT_PATH }}" ]; then
            echo "ðŸ“‚ Cloning repository..."
            git clone https://github.com/${{ github.repository }}.git ${{ env.PROJECT_PATH }}
          else
            echo "âœ… Project directory exists"
          fi

          cd ${{ env.PROJECT_PATH }}

          echo ""
          echo "ðŸ“¦ Pulling latest changes..."
          git fetch origin
          git reset --hard origin/${{ github.ref_name }}

          echo ""
          echo "âš™ï¸  Configuring environment..."
          cat > .env << 'ENVEOF'
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          DATABASE_URL=sqlite+aiosqlite:///./data/news_bot.db
          PARSE_INTERVAL_MINUTES=30
          MAX_NEWS_PER_REQUEST=10
          ENVEOF

          echo "ðŸ“ Creating directories..."
          mkdir -p data logs

          echo ""
          echo "ðŸ›‘ Stopping old container..."
          docker compose down 2>/dev/null || true

          echo ""
          echo "ðŸ—ï¸  Building Docker image..."
          docker compose build

          echo ""
          echo "ðŸš€ Starting container..."
          docker compose up -d

          echo ""
          echo "â³ Waiting for bot to start..."
          sleep 8

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ðŸ“Š Deployment Status"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Check container status
          docker compose ps

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ðŸ“‹ Bot Logs (last 30 lines)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          docker compose logs --tail=30

          echo ""

          # Verify container is running
          if docker compose ps | grep -q "Up"; then
            echo "âœ… Bot is running successfully!"
            exit 0
          else
            echo "âŒ Bot failed to start!"
            echo ""
            echo "Full logs:"
            docker compose logs
            exit 1
          fi

    - name: ðŸ“Š Deployment Summary
      if: always()
      run: |
        if [ "${{ steps.deploy.outcome }}" == "success" ]; then
          echo "### âœ… Deployment Successful! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ¤– **Bot is now running on the server!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Next steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Open Telegram and find your bot" >> $GITHUB_STEP_SUMMARY
          echo "2. Send /start to test" >> $GITHUB_STEP_SUMMARY
          echo "3. Add your favorite clubs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Useful commands:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker compose logs -f" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs above for error details." >> $GITHUB_STEP_SUMMARY
        fi
