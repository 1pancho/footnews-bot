name: Deploy to VPS with Notifications

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_PATH: /root/football-news-bot

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸš€ Deploy to VPS
      id: deploy
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        script_stop: false
        script: |
          set -e

          echo "ðŸ” Checking project directory..."
          if [ ! -d "${{ env.PROJECT_PATH }}" ]; then
            echo "ðŸ“‚ Cloning repository..."
            git clone https://github.com/${{ github.repository }}.git ${{ env.PROJECT_PATH }}
          fi

          cd ${{ env.PROJECT_PATH }}

          echo "ðŸ“¦ Pulling latest changes..."
          git fetch origin
          git reset --hard origin/main

          echo "âš™ï¸  Configuring environment..."
          if [ ! -f .env ]; then
            echo "Creating .env file..."
            cat > .env << 'ENVEOF'
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          DATABASE_URL=sqlite+aiosqlite:///./data/news_bot.db
          PARSE_INTERVAL_MINUTES=30
          MAX_NEWS_PER_REQUEST=10
          ENVEOF
          fi

          echo "ðŸ“ Creating directories..."
          mkdir -p data logs

          echo "ðŸ›‘ Stopping old container..."
          docker compose down || true

          echo "ðŸ—ï¸  Building and starting new container..."
          docker compose up -d --build

          echo "â³ Waiting for startup..."
          sleep 5

          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   âœ… Deployment Status                 â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          if docker compose ps | grep -q "Up"; then
            echo "âœ… Container is running"
            docker compose ps
            echo ""
            echo "ðŸ“‹ Recent logs:"
            docker compose logs --tail=20
            exit 0
          else
            echo "âŒ Container failed to start"
            docker compose ps
            docker compose logs --tail=50
            exit 1
          fi

    - name: ðŸ“Š Deployment Summary
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "### âœ… Deployment Successful! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Server**: ${{ secrets.VPS_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ¤– Bot should now be running with the latest changes!" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
        fi
